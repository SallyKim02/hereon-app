import { useMemo, useState } from "react";
import { Alert, Pressable, StyleSheet, Text, View } from "react-native";

type Pair = { id: string; auto: string; alt: string };

function shuffle<T>(arr: T[]) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

export default function CbtMatchingGameTab() {
  const PAIRS: Pair[] = useMemo(
    () => [
      {
        id: "p1",
        auto: "심장이 빨리 뛰니 큰일이야",
        alt: "심박 상승은 생리적 반응일 뿐, 위험 신호가 아닐 수 있어",
      },
      {
        id: "p2",
        auto: "또 분명 발작이 올 거야",
        alt: "이번에는 다를 수도 있어. 호흡과 현재 행동에 집중해보자",
      },
      {
        id: "p3",
        auto: "나는 불안하면 안 돼",
        alt: "불안은 경험할 수 있는 감정이야. 조절 연습을 하면 돼",
      },
    ],
    []
  );

  const [round] = useState(1);
  const [autoOrder, setAutoOrder] = useState(() => shuffle(PAIRS.map((p) => p.id)));
  const [altOrder, setAltOrder] = useState(() => shuffle(PAIRS.map((p) => p.id)));

  const [pickedAuto, setPickedAuto] = useState<string | null>(null);
  const [pickedAlt, setPickedAlt] = useState<string | null>(null);
  const [matched, setMatched] = useState<string[]>([]);

  const onShuffle = () => {
    setAutoOrder(shuffle(PAIRS.map((p) => p.id)));
    setAltOrder(shuffle(PAIRS.map((p) => p.id)));
    setPickedAuto(null);
    setPickedAlt(null);
  };

  const tryMatch = (a: string | null, b: string | null) => {
    if (!a || !b) return;
    if (a === b) {
      setMatched((prev) => (prev.includes(a) ? prev : [...prev, a]));
      setPickedAuto(null);
      setPickedAlt(null);
    } else {
      Alert.alert("다시 시도", "짝이 아니에요. 다시 선택해보세요.");
      setPickedAlt(null);
    }
  };

  const done = matched.length === PAIRS.length;

  return (
    <View style={{ flex: 1 }}>
      <View style={styles.topRow}>
        <Text style={styles.progress}>라운드 {round} / 1</Text>
        <Pressable onPress={onShuffle} style={styles.shuffleBtn}>
          <Text style={styles.shuffleText}>카드 섞기</Text>
        </Pressable>
      </View>

      <Text style={styles.hint}>자동적 사고(왼쪽)와 대안적 사고(오른쪽)를 맞춰보세요.</Text>

      <View style={styles.grid}>
        <View style={styles.col}>
          <Text style={styles.colTitle}>자동적 사고</Text>
          {autoOrder.map((id, i) => {
            const p = PAIRS.find((x) => x.id === id)!;
            const locked = matched.includes(id);
            const on = pickedAuto === id;

            return (
              <Pressable
                key={`${id}-${i}`}
                disabled={locked}
                onPress={() => {
                  setPickedAuto(id);
                  tryMatch(id, pickedAlt);
                }}
                style={[styles.card, on && styles.cardOn, locked && styles.cardLocked]}
              >
                <Text style={[styles.cardText, on && styles.cardTextOn]}>{p.auto}</Text>
              </Pressable>
            );
          })}
        </View>

        <View style={styles.col}>
          <Text style={styles.colTitle}>대안적 사고</Text>
          {altOrder.map((id, i) => {
            const p = PAIRS.find((x) => x.id === id)!;
            const locked = matched.includes(id);
            const on = pickedAlt === id;

            return (
              <Pressable
                key={`${id}-${i}`}
                disabled={locked}
                onPress={() => {
                  setPickedAlt(id);
                  tryMatch(pickedAuto, id);
                }}
                style={[styles.card, on && styles.cardOn, locked && styles.cardLocked]}
              >
                <Text style={[styles.cardText, on && styles.cardTextOn]}>{p.alt}</Text>
              </Pressable>
            );
          })}
        </View>
      </View>

      {done ? (
        <View style={styles.doneBox}>
          <Text style={styles.doneTitle}>완료!</Text>
          <Text style={styles.doneDesc}>수고했어요. 다음에도 연습해볼까요?</Text>
        </View>
      ) : (
        <Text style={styles.footerHint}>맞춘 카드: {matched.length} / {PAIRS.length}</Text>
      )}
    </View>
  );
}

const DARK = "#3B3B3B";
const CARD = "#FFFFFF";

const styles = StyleSheet.create({
  topRow: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", marginBottom: 8 },
  progress: { color: DARK, fontWeight: "900" },
  shuffleBtn: { backgroundColor: "rgba(0,0,0,0.06)", paddingHorizontal: 12, paddingVertical: 10, borderRadius: 999 },
  shuffleText: { color: DARK, fontWeight: "900" },

  hint: { color: "rgba(0,0,0,0.55)", fontWeight: "700", marginBottom: 10 },

  grid: { flexDirection: "row", gap: 10, flex: 1 },
  col: { flex: 1, gap: 10 },
  colTitle: { color: DARK, fontWeight: "900", marginBottom: 2 },

  card: { backgroundColor: CARD, borderRadius: 18, padding: 12 },
  cardOn: { backgroundColor: DARK },
  cardLocked: { opacity: 0.45 },
  cardText: { color: DARK, fontWeight: "800", lineHeight: 18 },
  cardTextOn: { color: "#fff" },

  footerHint: { marginTop: 10, color: "rgba(0,0,0,0.55)", fontWeight: "800" },

  doneBox: {
    marginTop: 12,
    backgroundColor: CARD,
    borderRadius: 18,
    padding: 14,
    alignItems: "center",
  },
  doneTitle: { color: DARK, fontWeight: "900", fontSize: 16 },
  doneDesc: { marginTop: 6, color: "rgba(0,0,0,0.55)", fontWeight: "700" },
});
